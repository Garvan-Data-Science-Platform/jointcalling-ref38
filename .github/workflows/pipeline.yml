name: Fetch checkout and run on NCI
on:
  pull_request:

jobs:
  setup-and-test:
    permissions:
      contents: "read"
      id-token: "write"
    timeout-minutes: 8640
    runs-on: self-hosted
    steps:
      - name: Set up hpci
        uses: Garvan-Data-Science-Platform/hpci-reusable-actions/.github/actions/setup-hpci@main
        with:
          submodule_token: ${{ secrets.SUBMODULE_TOKEN }}
          project_id: ${{ secrets.PROJECT_ID }}
          project_number: ${{ secrets.PROJECT_NUMBER }}
          registry_sa: ${{ secrets.REGISTRY_SA }}
          key_prefix: "prod_bio"
          hpci_version: "0.0.3"

      - name: Set env
        shell: bash
        run: |
          TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
          REPO=${{ github.event.repository.name }}
          GIT_REF=${{ github.head_ref }}
          URL=git@github.com:${{ github.repository }}.git

          # Append each to $GITHUB_ENV
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "REPO=$REPO" >> $GITHUB_ENV
          echo "GIT_REF=$GIT_REF" >> $GITHUB_ENV
          echo "URL=$URL" >> $GITHUB_ENV

          # Use variables directly to define INSTANCE_PARENT
          INSTANCE_PARENT="/scratch/np30/test_repositories/$REPO/$GIT_REF/$TIMESTAMP"
          echo "INSTANCE_PARENT=$INSTANCE_PARENT" >> $GITHUB_ENV

      - name: Clone repo
        id: run_jobs
        run: |
          jobs=("clone")
          for job in "${jobs[@]}"; do
            hpci-exe \
              --user ${{secrets.USER_NAME}} \
              --host ${{secrets.HOST_NAME}} \
              --port 22 \
              --publicKey access_key.pub \
              --privateKey access_key \
              schedule \
              --script hpci-scripts/$job.pbs \
              --logFile $job.log \
              -c INSTANCE_PARENT=$INSTANCE_PARENT,REPO=$REPO,GIT_REF=$GIT_REF,URL=$URL
          done

      - name: Run pipeline
        run: |
          hpci-exe \
            --user ${{secrets.USER_NAME}} \
            --host ${{secrets.HOST_NAME}} \
            --port 22 \
            --publicKey access_key.pub \
            --privateKey access_key \
            schedule \
            --script JointCaller.sh \
            --logFile $INSTANCE_PARENT/$REPO/.nextflow.log \
            -c INSTANCE_PARENT=$INSTANCE_PARENT,REPO=$REPO,GIT_REF=$GIT_REF,URL=$URL

      - name: Run happy
        run: |
          hpci-exe \
            --user ${{secrets.USER_NAME}} \
            --host ${{secrets.HOST_NAME}} \
            --port 22 \
            --publicKey access_key.pub \
            --privateKey access_key \
            schedule \
            --script happy.sh \
            --logFile $INSTANCE_PARENT/$REPO/happy_results/NA12878_chr21.summary.csv \
            -c INSTANCE_PARENT=$INSTANCE_PARENT,REPO=$REPO,GIT_REF=$GIT_REF,URL=$URL,QUERY_VCF=output/jointCallRef38.ch21.vcf.gz,TRUTH_VCF=/scratch/np30/eu1813/happy/ref38/HG001_GRCh38_GIAB_highconf_CG-IllFB-IllGATKHC-Ion-10X-SOLID_CHROM1-X_v.3.3.2_highconf_PGandRTGphasetransfer.vcf.gz,BED_FILE=/scratch/np30/eu1813/happy/ref38/HG001_GRCh38_GIAB_highconf_CG-IllFB-IllGATKHC-Ion-10X-SOLID_CHROM1-X_v.3.3.2_highconf_nosomaticdel_noCENorHET7.bed,REF=/scratch/np30/eu1813/happy/ref38/Homo_sapiens_assembly38.fasta,REGIONS=/scratch/np30/eu1813/happy/ref38/reportable_range-1.0.hg38.chr21.bed

      - name: Clean up
        run: rm access_key*
